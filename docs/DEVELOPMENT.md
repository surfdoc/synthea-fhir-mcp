# Development Guide

This guide provides instructions for developing and contributing to the Synthea FHIR MCP Server.

## Project Overview

This MCP (Model Context Protocol) server provides Claude Desktop with access to synthetic healthcare data in FHIR format, generated by Synthea and stored in PostgreSQL.

**Key Features:**
- Healthcare-specific query tools for FHIR resources
- JSONB optimization for FHIR data structures
- SSE (Server-Sent Events) for Claude Desktop integration
- Google Cloud Run deployment
- Read-only access to synthetic patient data

## Architecture

### Core Components
- **FastMCP Framework**: Handles MCP protocol implementation
- **psycopg3**: PostgreSQL adapter with dict_row factory
- **Pydantic Models**: Type validation for tool inputs
- **FastAPI**: Web framework for HTTP/SSE endpoints

### Transport Support
- stdio (default)
- SSE (Server-Sent Events) for Claude Desktop
- Streamable HTTP for web clients

## Development Setup

### Prerequisites
- Python 3.10+
- PostgreSQL (optional for testing)
- Docker (optional)

### Local Development

1. Clone the repository:
```bash
git clone https://github.com/surfdoc/mcp-postgres-to-synthea-fhir-mcp.git
cd mcp-postgres-to-synthea-fhir-mcp
```

2. Create virtual environment:
```bash
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

3. Install dependencies:
```bash
pip install -r requirements.txt
pip install -r dev-requirements.txt  # For testing
```

4. Set up environment variables:
```bash
cp .env.example .env
# Edit .env with your database credentials
```

5. Run tests:
```bash
pytest
```

### Running the Servers

#### Generic PostgreSQL Server:
```bash
# Without database connection (inspection mode)
python src/postgres_server.py

# With database connection
export POSTGRES_CONNECTION_STRING="postgresql://user:pass@host:5432/db"
python src/postgres_server.py
```

#### Synthea FHIR Server:
```bash
# Local development with SSE
python src/synthea_server.py

# With database connection
export DATABASE_URL="postgresql://user:pass@host:5432/synthea"
python src/synthea_server.py
```

## Testing

### Unit Tests
```bash
pytest tests/
```

### Integration Testing
```bash
# Test with actual database
export POSTGRES_CONNECTION_STRING="postgresql://test_db"
pytest tests/ -m integration
```

### Manual Testing with Claude Desktop
1. Configure Claude Desktop to use local server
2. Use test queries from docs/BETA_SETUP.md

## Adding New Tools

### For Generic PostgreSQL Server

1. Add tool definition to TOOLS list:
```python
TOOLS = [
    Tool(
        name="your_tool",
        description="Tool description",
        input_schema=YourInputModel,
        fn=your_tool_function
    )
]
```

2. Implement the tool function:
```python
async def your_tool_function(input: YourInputModel) -> str:
    # Implementation
    return result
```

### For Synthea Server

1. Add to TOOLS array:
```python
{
    "name": "your_tool",
    "description": "Tool description",
    "inputSchema": {
        "type": "object",
        "properties": {...}
    }
}
```

2. Add handler in handle_call_tool:
```python
elif tool_name == "your_tool":
    # Implementation
    return MCPResponse(...)
```

## Database Schema

### Generic PostgreSQL
- Works with any PostgreSQL database
- No schema assumptions
- Tools discover schema dynamically

### Synthea FHIR Schema
```
fhir.patient
fhir.observation
fhir.condition
fhir.procedure
fhir.medication_request
fhir.encounter
fhir.immunization
fhir.allergy_intolerance
```

All FHIR data stored as JSONB in `resource` column.

## Environment Variables

### Common
- `POSTGRES_CONNECTION_STRING`: Database connection string
- `POSTGRES_READONLY`: Set to "true" for read-only mode
- `POSTGRES_STATEMENT_TIMEOUT_MS`: Query timeout (default: 15000)

### Synthea Server Specific
- `CLOUD_SQL_CONNECTION_NAME`: Cloud SQL instance connection
- `DB_USER`: Database username
- `DB_PASSWORD`: Database password
- `DB_NAME`: Database name
- `PORT`: Server port (default: 8080)

## Deployment

See [DEPLOYMENT.md](DEPLOYMENT.md) for deployment instructions.

## Code Style

- Follow PEP 8
- Use type hints
- Add docstrings to functions
- Keep functions focused and testable

## Contributing

1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Ensure all tests pass
5. Submit a pull request

## Troubleshooting

### Common Issues

1. **Connection timeout**: Check database credentials and network
2. **Import errors**: Ensure all dependencies installed
3. **SSE not working**: Check CORS settings and client configuration

### Debug Mode

Enable debug logging:
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## License

MIT License - see LICENSE file for details